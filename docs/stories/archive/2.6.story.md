# Story 2.6: Cascading Delete

**Epic:** Frontend Application (Next.js)

## Status
Completed

## Story
**As a** System Administrator,
**I want** to be able to delete a farm and all its associated data (substations, turbines, etc.) in a single action,
**so that** I can maintain a clean database without manual cleanup of dependencies.

---

## Acceptance Criteria

1. **AC1:** A "Delete" button is available on the Farm Details page.
2. **AC2:** Clicking "Delete" triggers a confirmation dialog to prevent accidental deletion.
3. **AC3:** The user must confirm the action by typing the farm's code (to ensure intention).
4. **AC4:** On confirmation, the frontend calls the `DELETE /farms/{uuid}` endpoint.
5. **AC5:** The backend correctly handles the cascading deletion of all related records in Supabase.
6. **AC6:** On successful deletion, the user is redirected back to the Farm List.
7. **AC7:** Only authenticated users can perform this action.

---

## Tasks / Subtasks

- [x] **Task 1: Update Backend for Cascading Delete** (AC5)
  - [x] Update the `DELETE /farms/:uuid` handler in `backend/src/routes/farms.ts`
  - [x] Implement explicit deletion of records in `farm_locations`, `farm_statuses`, `farm_turbine_details`, `substations`, etc.

- [x] **Task 2: Create Confirmation Dialog Component** (AC2)
  - [x] Create manual `Dialog` component library in `frontend/src/components/ui/dialog.tsx`

- [x] **Task 3: Implement Delete Logic on Farm Details Page** (AC1, AC3, AC4)
  - [x] Add `Dialog` to `FarmDetailPage`
  - [x] Implement code verification logic (`confirmCode === farm.code`)
  - [x] Integrate with `api.delete` and handle loading state

- [x] **Task 4: Redirection and Notification** (AC6)
  - [x] Redirect to `/farms` on success via `router.push`

---

## Dev Notes

### Backend Implementation
- The backend now explicitly deletes records from 7 related tables before removing the main farm record, ensuring no foreign key violations occur even if `ON DELETE CASCADE` is not set in the DB.

### UI Components
- Added a full set of `Dialog` components: `Dialog`, `DialogContent`, `DialogHeader`, `DialogFooter`, `DialogTitle`, `DialogDescription`.

---

## Testing

- **Manual Verification**: 
  - Created a test farm.
  - Attempted to delete with wrong code (button disabled).
  - Deleted with correct code -> Redirected to list, farm gone.
  - Verified that accessing a deleted farm URL shows an error page.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 1.0 | Initial story creation | Dev Agent |
| 2026-02-05 | 1.1 | Implementation completed and verified | Dev Agent |

---

## Dev Agent Record

### Agent Model Used
Gemini 2.0 Flash

### File List
- `backend/src/routes/farms.ts` (updated)
- `frontend/src/components/ui/dialog.tsx`
- `frontend/src/app/farms/[uuid]/page.tsx` (updated)
- `docs/stories/2.6.story.md`