# Story 2.2: Frontend Authentication Integration

**Epic:** Frontend Application (Next.js)

## Status
Completed

## Story
**As a** User,
**I want** to be able to sign in with my Microsoft account from the web interface,
**so that** I can access protected farm management features.

---

## Acceptance Criteria

1. **AC1:** A "Sign in with Microsoft" button on the home page initiates the login flow.
2. **AC2:** The application handles the OAuth redirect and retrieves the access token from the backend.
3. **AC3:** The access token is stored securely (e.g., in localStorage for this MVP) and persists across page reloads.
4. **AC4:** An `AuthContext` provider is implemented to provide user state (logged in/out, user info) throughout the app.
5. **AC5:** API requests to protected backend routes automatically include the `Authorization: Bearer <token>` header.
6. **AC6:** The UI updates based on the authentication state (e.g., showing a "Sign Out" button when logged in).
7. **AC7:** A "Sign Out" feature clears the stored token and user state.

---

## Tasks / Subtasks

- [x] **Task 1: Create API Client Utility** (AC5)
  - [x] Implement a base fetch wrapper in `frontend/src/lib/api.ts` that adds the Bearer token
  - [x] Configure the backend base URL

- [x] **Task 2: Implement Auth Context & Provider** (AC4)
  - [x] Create `AuthContext` to track `user` and `token`
  - [x] Implement `AuthProvider` with `login`, `logout`, and `setAuthData` methods
  - [x] Wrap the application in `AuthProvider` in `layout.tsx`

- [x] **Task 3: Implement Login Flow** (AC1, AC2)
  - [x] Update Home page to call backend `/auth/login` on button click
  - [x] Modify Backend to redirect directly to Azure and back to Frontend callback
  - [x] Create `frontend/src/app/auth/callback/page.tsx` to handle tokens from URL

- [x] **Task 4: Token Storage** (AC3)
  - [x] Implement logic to store the token in `localStorage`
  - [x] Restore user session on app load using `/me` endpoint

- [x] **Task 5: UI Integration & Sign Out** (AC6, AC7)
  - [x] Show user profile info when logged in
  - [x] Implement "Sign Out" button and logic

---

## Dev Notes

### Backend Changes
- Added `FRONTEND_URL` variable to `wrangler.toml`.
- Updated `/auth/login` to redirect to Azure.
- Updated `/auth/callback` to redirect back to the frontend with tokens in the URL.

### Frontend Changes
- Created `api.ts` utility for fetch requests.
- Created `AuthContext` for global auth state.
- Created `auth/callback` page to capture tokens.
- Updated Home page to be dynamic based on auth state.

---

## Testing

- **Manual Verification**: 
  - Clicked login -> Redirected to Microsoft (mock/real) -> Redirected back to app.
  - User name and email displayed on home page after login.
  - Sign Out button clears storage and returns to guest view.
- **Header Check**: API utility verified to include `Authorization` header.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 1.0 | Initial story creation | Dev Agent |
| 2026-02-05 | 1.1 | Implementation completed and verified | Dev Agent |

---

## Dev Agent Record

### Agent Model Used
Gemini 2.0 Flash

### File List
- `backend/src/config/auth.ts`
- `backend/src/routes/auth.ts`
- `backend/wrangler.toml`
- `frontend/src/lib/api.ts`
- `frontend/src/context/AuthContext.tsx`
- `frontend/src/app/layout.tsx`
- `frontend/src/app/page.tsx`
- `frontend/src/app/auth/callback/page.tsx`
- `docs/stories/2.2.story.md`